generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Campaign {
  id            String    @id @default(cuid())
  name          String
  subject       String
  fromName      String
  fromEmail     String
  replyTo       String?
  content       String    @db.Text
  contentType   String    @default("html")
  templateId    String?
  template      Template? @relation(fields: [templateId], references: [id])

  status        CampaignStatus @default(DRAFT)
  scheduledAt   DateTime?
  startedAt     DateTime?
  completedAt   DateTime?

  totalRecipients  Int @default(0)
  sentCount        Int @default(0)
  deliveredCount   Int @default(0)
  openedCount      Int @default(0)
  clickedCount     Int @default(0)
  bouncedCount     Int @default(0)
  unsubscribedCount Int @default(0)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  recipients    Recipient[]
  events        EmailEvent[]

  @@index([status])
  @@index([createdAt])
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  PAUSED
  COMPLETED
  CANCELLED
}

model Template {
  id          String   @id @default(cuid())
  name        String   @unique
  subject     String?
  content     String   @db.Text
  thumbnail   String?
  category    String?
  isDefault   Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaigns   Campaign[]

  @@index([category])
}

model Contact {
  id          String   @id @default(cuid())
  email       String   @unique
  firstName   String?
  lastName    String?
  company     String?
  customField1 String?
  customField2 String?
  tags        String[] @default([])

  status      ContactStatus @default(ACTIVE)
  unsubscribedAt DateTime?
  bouncedAt   DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  recipients  Recipient[]
  listMembers ContactListMember[]

  @@index([email])
  @@index([status])
  @@index([firstName])
  @@index([lastName])
}

enum ContactStatus {
  ACTIVE
  UNSUBSCRIBED
  BOUNCED
  COMPLAINED
}

model ContactList {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  contactCount Int     @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     ContactListMember[]
}

model ContactListMember {
  id          String      @id @default(cuid())
  listId      String
  list        ContactList @relation(fields: [listId], references: [id], onDelete: Cascade)
  contactId   String
  contact     Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)

  createdAt   DateTime    @default(now())

  @@unique([listId, contactId])
}

model Recipient {
  id          String   @id @default(cuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contactId   String?
  contact     Contact? @relation(fields: [contactId], references: [id])
  email       String

  status      RecipientStatus @default(PENDING)
  sentAt      DateTime?
  deliveredAt DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  bouncedAt   DateTime?
  bounceType  String?
  errorMessage String?

  openCount   Int @default(0)
  clickCount  Int @default(0)

  trackingId  String @unique @default(cuid())

  createdAt   DateTime @default(now())

  events      EmailEvent[]

  @@unique([campaignId, email])
  @@index([campaignId])
  @@index([email])
  @@index([status])
  @@index([trackingId])
}

enum RecipientStatus {
  PENDING
  QUEUED
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  FAILED
  UNSUBSCRIBED
}

model EmailEvent {
  id          String   @id @default(cuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  recipientId String
  recipient   Recipient @relation(fields: [recipientId], references: [id], onDelete: Cascade)

  type        EventType
  metadata    Json?

  createdAt   DateTime  @default(now())

  @@index([campaignId])
  @@index([recipientId])
  @@index([type])
  @@index([createdAt])
}

enum EventType {
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  UNSUBSCRIBED
  COMPLAINED
}

model SmtpConfig {
  id          String   @id @default(cuid())
  name        String   @unique
  host        String
  port        Int
  secure      Boolean  @default(false)
  username    String
  password    String
  fromEmail   String
  fromName    String
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Unsubscribe {
  id          String   @id @default(cuid())
  email       String
  campaignId  String?
  reason      String?
  token       String   @unique

  createdAt   DateTime @default(now())

  @@index([email])
  @@index([token])
}
